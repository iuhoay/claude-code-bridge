#!/bin/bash
set -euo pipefail

# Claude Code Bridge (ccb)
# Switch between different Claude Code service providers

CONFIG_DIR="${CCB_CONFIG_DIR:-$HOME/.config/claude_code_bridge}"
CONFIG_FILE="${CCB_CONFIG_FILE:-$CONFIG_DIR/providers.json}"

# Show help
show_help() {
  cat <<EOF
Usage: ccb [provider_name] [claude_args...]
       ccb --set-default [provider_name]

If no provider name is specified, use default provider or show interactive selection menu

Examples:
  ccb                    # Use default provider or show interactive selection
  ccb anthropic          # Use Anthropic provider
  ccb z_ai --help        # Use Z.AI provider and pass --help to Claude
  ccb --set-default z_ai # Set Z.AI as the default provider

Config file format ($CONFIG_FILE):
{
  "default_provider": "anthropic",
  "providers": {
    "anthropic": {
      "name": "Anthropic Official",
      "description": "Uses Claude Code's default configuration, no environment variables needed"
    },
    "z_ai": {
      "name": "Z.AI",
      "env": {
        "ANTHROPIC_AUTH_TOKEN": "your_api_key_here",
        "ANTHROPIC_BASE_URL": "https://api.z.ai/api/anthropic",
        "ANTHROPIC_DEFAULT_HAIKU_MODEL": "glm-4.5-air",
        "ANTHROPIC_DEFAULT_SONNET_MODEL": "glm-4.7",
        "ANTHROPIC_DEFAULT_OPUS_MODEL": "glm-4.7"
      }
    }
  }
}
EOF
}

# Check if jq is available
check_jq() {
  if ! command -v jq &>/dev/null; then
    echo "Error: jq is required but not installed" >&2
    echo "Please install jq: brew install jq (macOS) or apt-get install jq (Ubuntu)" >&2
    exit 1
  fi
}

# Validate config file exists and is readable
validate_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: Config file not found: $CONFIG_FILE" >&2
    echo "Create config directory and add provider configurations:" >&2
    echo "  mkdir -p '$CONFIG_DIR'" >&2
    echo "  Create '$CONFIG_FILE' with provider configurations" >&2
    exit 1
  fi

  if [[ ! -r "$CONFIG_FILE" ]]; then
    echo "Error: Config file not readable: $CONFIG_FILE" >&2
    exit 1
  fi
}

# Parse and validate provider configuration
parse_providers() {
  local config_content
  config_content=$(jq -r '.providers // {}' "$CONFIG_FILE" 2>/dev/null) || {
    echo "Error: Invalid JSON in config file: $CONFIG_FILE" >&2
    exit 1
  }

  local provider_count
  provider_count=$(echo "$config_content" | jq -r 'keys | length')

  if [[ "$provider_count" -eq 0 ]]; then
    echo "Error: No provider configurations found in config file" >&2
    exit 1
  fi

  echo "$config_content"
}

# Get default provider from config
get_default_provider() {
  validate_config
  check_jq

  local default_provider
  default_provider=$(jq -r '.default_provider // empty' "$CONFIG_FILE" 2>/dev/null)

  if [[ -z "$default_provider" ]]; then
    return 1
  fi

  # Verify that the default provider exists
  local providers
  providers=$(parse_providers)

  if ! echo "$providers" | jq -e ".\"$default_provider\"" >/dev/null 2>&1; then
    echo "Warning: Default provider '$default_provider' not found in providers configuration" >&2
    return 1
  fi

  echo "$default_provider"
}

# Set default provider in config
set_default_provider() {
  local provider_name="$1"

  validate_config
  check_jq

  # Verify provider exists
  local providers
  providers=$(parse_providers)

  if ! echo "$providers" | jq -e ".\"$provider_name\"" >/dev/null 2>&1; then
    echo "Error: Provider not found: $provider_name" >&2
    exit 1
  fi

  # Update config file with new default
  local temp_file
  temp_file=$(mktemp)

  if jq --arg default "$provider_name" '. + {default_provider: $default}' "$CONFIG_FILE" >"$temp_file"; then
    mv "$temp_file" "$CONFIG_FILE"
    local display_name
    display_name=$(echo "$providers" | jq -r ".\"$provider_name\".name // \"$provider_name\"")
    echo "Default provider set to: $display_name ($provider_name)"
  else
    rm -f "$temp_file"
    echo "Error: Failed to update default provider" >&2
    exit 1
  fi
}

# Show provider selection menu
select_provider() {
  echo "Select Claude Code Provider:"
  echo "----------------------------------------"

  validate_config
  check_jq

  local providers
  providers=$(parse_providers)

  local provider_names
  IFS=$'\n' read -r -d '' -a provider_names < <(echo "$providers" | jq -r 'keys[]' && printf '\0')

  # Show selection menu with provider names
  for ((i = 0; i < ${#provider_names[@]}; i++)); do
    local provider_name="${provider_names[i]}"
    local display_name
    display_name=$(echo "$providers" | jq -r ".\"$provider_name\".name // \"$provider_name\"")
    echo "$((i + 1))) $display_name ($provider_name)"
  done

  echo ""
  local choice
  read -p "Select provider (1-${#provider_names[@]}): " choice

  if [[ $choice =~ ^[0-9]+$ ]] && [[ $choice -ge 1 ]] && [[ $choice -le ${#provider_names[@]} ]]; then
    local provider_index=$((choice - 1))
    launch_claude "${provider_names[provider_index]}" "$@"
  else
    echo "Error: Invalid selection" >&2
    exit 1
  fi
}

# Set environment variables and launch Claude
launch_claude() {
  local provider_name="$1"
  shift

  validate_config
  check_jq

  local providers
  providers=$(parse_providers)

  # Check if provider exists
  if ! echo "$providers" | jq -e ".\"$provider_name\"" >/dev/null 2>&1; then
    echo "Error: Provider not found: $provider_name" >&2
    exit 1
  fi

  # Get provider display name
  local display_name
  display_name=$(echo "$providers" | jq -r ".\"$provider_name\".name // \"$provider_name\"")

  # Set environment variables from env object (if present)
  # Skip if this is the native anthropic provider (no env vars needed)
  if [[ "$provider_name" != "anthropic" ]]; then
    # Check if provider has an env object
    if echo "$providers" | jq -e ".\"$provider_name\".env" >/dev/null 2>&1; then
      # Set environment variables directly from the env object
      while IFS='=' read -r key value; do
        if [[ -n "$key" ]]; then
          export "$key=$value"
        fi
      done < <(echo "$providers" | jq -r ".\"$provider_name\".env | to_entries | .[] | \"\(.key)=\(.value)\"")
    else
      echo "Warning: Provider '$provider_name' has no 'env' object configured. No environment variables will be set." >&2
    fi
  fi

  echo "Launching Claude Code - Provider: $display_name"
  echo "----------------------------------------"

  # Execute Claude directly
  exec claude "$@"
}

# Main function
main() {
  case "${1:-}" in
  -h | --help | help)
    show_help
    ;;
  --set-default)
    if [[ $# -lt 2 ]]; then
      echo "Error: Provider name required for --set-default" >&2
      echo "Usage: ccb --set-default <provider_name>" >&2
      exit 1
    fi
    set_default_provider "$2"
    ;;
  "")
    # Try to use default provider, fallback to interactive selection
    local default_provider
    if default_provider=$(get_default_provider); then
      launch_claude "$default_provider" "${@:2}"
    else
      select_provider "${@:2}"
    fi
    ;;
  *)
    # Check if first argument is a provider name or a Claude option
    if [[ "$1" == -* ]]; then
      # It's a Claude option, use default provider or fall back to interactive selection
      local default_provider
      if default_provider=$(get_default_provider); then
        launch_claude "$default_provider" "$@"
      else
        echo "Error: No default provider set and no provider specified" >&2
        echo "Use 'ccb --set-default <provider>' to set a default provider" >&2
        echo "Or specify a provider: ccb <provider> [options]" >&2
        exit 1
      fi
    else
      # First argument is treated as provider name
      launch_claude "$@"
    fi
    ;;
  esac
}

main "$@"
